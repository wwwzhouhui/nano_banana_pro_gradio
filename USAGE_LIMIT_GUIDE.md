# 用户每日限制功能说明

## 概述

已为 `app.py` 添加了每日用户使用限制功能，支持本地开发模式和生产环境模式。

## 主要功能

### ✅ 已实现的功能

1. **灵活的限制模式**
   - **本地开发模式**（默认）：关闭用户限制，无需登录，可无限制使用
   - **生产环境模式**：启用用户限制，需要 ModelScope 平台请求头

2. **每日限制机制**（仅生产环境）
   - 每位用户每天可使用文生图和图生图功能的总次数限制
   - 默认限制：每天 3 次（可配置）
   - 在每天 00:00 自动重置

3. **用户识别**（仅生产环境）
   - 通过 HTTP 请求头 `x-modelscope-router-id` 识别用户
   - 匿名用户（无请求头）无法使用生成功能

4. **使用记录存储**
   - 数据存储路径：`./data/daily_user_usage.json`（项目目录下的 data 文件夹）
   - 数据格式：
     ```json
     {
       "2025-11-24": {
         "user-123": 2,
         "user-456": 3
       },
       "2025-11-25": {
         "user-123": 1
       }
     }
     ```

5. **用户状态显示**
   - **本地模式**：显示"本地开发模式"提示
   - **生产模式**：实时显示用户今日剩余次数

6. **智能扣费**（仅生产环境）
   - 仅在生成成功时扣除次数
   - 失败的请求不计入使用次数

## 配置方法

### 环境变量配置

在 `.env` 文件中添加：

```bash
# 是否启用用户限制（true/false）
# - true: 启用限制（适用于生产环境，需要 ModelScope 平台部署）
# - false: 关闭限制（适用于本地开发，无需登录）
# 默认值：false
ENABLE_USER_LIMIT=false

# 用户每日使用限制配置（仅在 ENABLE_USER_LIMIT=true 时生效）
DAILY_USAGE_LIMIT=3
```

### 使用场景

#### 1. 本地开发（默认模式）

不需要任何配置，直接启动即可：

```bash
python app.py
```

特点：
- ✅ 无需登录
- ✅ 无使用次数限制
- ✅ 适合本地测试和开发

#### 2. 生产环境（ModelScope 部署）

在 `.env` 文件中设置：

```bash
ENABLE_USER_LIMIT=true
DAILY_USAGE_LIMIT=3
```

然后启动应用：

```bash
python app.py
```

特点：
- ⚠️ 需要 ModelScope 平台请求头
- ⚠️ 每位用户每天限制 3 次（可配置）
- ⚠️ 匿名用户无法使用

### 修改限制次数

1. **方法一：修改 .env 文件**
   ```bash
   # 修改为每天 5 次
   ENABLE_USER_LIMIT=true
   DAILY_USAGE_LIMIT=5
   ```

2. **方法二：设置系统环境变量**
   ```bash
   export ENABLE_USER_LIMIT=true
   export DAILY_USAGE_LIMIT=10
   ```

3. **重启应用使配置生效**
   ```bash
   python app.py
   ```

## 代码修改详情

### 1. 新增配置 (app.py:27-34)

```python
# ==================== 用户限制配置 ====================
DAILY_USAGE_LIMIT = int(os.getenv('DAILY_USAGE_LIMIT', 3))  # 每天使用限制次数，默认3次
ENABLE_USER_LIMIT = os.getenv('ENABLE_USER_LIMIT', 'false').lower() == 'true'  # 是否启用用户限制，默认关闭
# 获取项目根目录
PROJECT_ROOT = Path(__file__).parent
# 数据存储目录
DATA_DIR = PROJECT_ROOT / 'data'
USAGE_FILE_PATH = DATA_DIR / 'daily_user_usage.json'  # 每日使用记录文件
```

### 2. 装饰器增强 (app.py:137-197)

```python
@daily_limit_wrapper
def text_to_image(...):
    # 文生图功能
```

装饰器功能：
- **本地模式**：直接执行，跳过所有检查
- **生产模式**：
  - 验证用户身份
  - 检查今日剩余次数
  - 执行生成功能
  - 成功后扣除次数
  - 更新用户状态显示

### 3. 界面自适应 (app.py:534-559)

根据 `ENABLE_USER_LIMIT` 的值显示不同的界面提示：

**本地模式**：
```
### ℹ️ 本地开发模式
用户限制功能已关闭，您可以无限制地生成图片。
如需启用用户限制，请在 .env 文件中设置 `ENABLE_USER_LIMIT=true`。
```

**生产模式**：
```
### ⚠️ 使用限制提示
每位用户每天最多可生成 **3** 次（文生图 + 图生图合计）。
次数在每天 00:00 自动重置。
```

## 启动信息

启动时会显示当前模式：

```bash
============================================================
🎨 Gemai Nano Banana Pro
============================================================
📦 启动模式: 集成模式（FastAPI + Gradio）
============================================================
📁 用户使用记录文件: /path/to/data/daily_user_usage.json
ℹ️  用户限制: 已关闭（本地开发模式）
============================================================
```

或

```bash
============================================================
📁 用户使用记录文件: /path/to/data/daily_user_usage.json
⚠️  用户限制: 已启用（每日限制 3 次）
============================================================
```

## 与 app11.py 的区别

| 特性 | app11.py | app.py (修改后) |
|------|----------|-----------------|
| 限制类型 | 总次数限制 | **每日限制** |
| 重置机制 | 永不重置 | **每天 00:00 自动重置** |
| 数据结构 | `{"user_id": count}` | `{"date": {"user_id": count}}` |
| 配置参数 | `USAGE_LIMIT` | `DAILY_USAGE_LIMIT` |
| 存储路径 | `/mnt/workspace/user_usage.json` | `./data/daily_user_usage.json` |
| 存储文件 | `user_usage.json` | `daily_user_usage.json` |
| 适用功能 | 部分功能 | 文生图 + 图生图 |

## 错误提示

### 1. 匿名用户访问
```
❌ 身份验证失败：请求中缺少 X-Modelscope-Router-Id 请求头
❌ Authentication failed: Missing X-Modelscope-Router-Id header
```

### 2. 达到每日限制
```
❌ 今日使用次数已达上限（3 次）
❌ Daily usage limit reached (max 3 generations)
```

### 3. 生成成功提示
```
✅ 生成成功！今日剩余次数: 2/3
```

## 测试建议

1. **测试匿名用户**
   - 不带 `x-modelscope-router-id` 请求头访问
   - 应显示身份验证失败

2. **测试限制功能**
   - 设置 `DAILY_USAGE_LIMIT=2`
   - 连续生成 3 次，第 3 次应被拦截

3. **测试每日重置**
   - 手动修改 `./data/daily_user_usage.json` 中的日期
   - 验证新日期下计数重新开始

4. **测试失败不扣费**
   - 输入错误参数导致生成失败
   - 验证使用次数未减少

## 数据管理

### 查看使用记录

```bash
cat ./data/daily_user_usage.json
```

### 清空使用记录

```bash
echo '{}' > ./data/daily_user_usage.json
```

### 重置特定用户

编辑 `./data/daily_user_usage.json`，删除对应用户的记录。

## 注意事项

1. **文件权限**：确保应用有权限读写项目目录下的 `data/` 文件夹
2. **时区问题**：日期基于服务器时区，确保时区设置正确
3. **并发安全**：当前实现使用文件锁，支持并发访问
4. **历史数据**：历史日期的数据会保留，可定期清理
5. **数据目录**：`data/` 目录会在首次运行时自动创建

## 扩展建议

如果需要更高级的功能，可以考虑：

1. **数据库存储**：替换 JSON 文件，使用 SQLite/MySQL
2. **定时清理**：自动删除 7 天前的历史记录
3. **不同等级限制**：为不同用户设置不同的每日限额
4. **使用统计**：添加使用量统计和分析功能
5. **重置时间可配置**：支持自定义重置时间（如每天凌晨 2 点）

---

**修改完成日期**: 2025-11-24
**参考文件**: app11.py
**修改文件**: app.py
